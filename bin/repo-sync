#! /usr/bin/zsh -fue

# invoke repo sync, and then restore the checked-out branches.
# It's assumed they know how to rebase. ( git-rebase-* cmds)

STEP_COLOR=green


start_git_heads=git-heads.txt-$(date +%d-%H)
# cecho $STEP_COLOR "saving sha1-s in git-heads.txt ... in background"
mv -f git-heads.txt $start_git_heads
# taken from gen_platform_zip:
{
    #pid1=$tmpsess
    cecho $STEP_COLOR "saving sym refs in horizon.pre"
    repo_save_horizon > horizon.pre &
    #pid2=$tmpsess
    wait
    #$pid1 $pid2
}


cecho blue "Here the sym-ref horizon:"
cat horizon.pre

#cecho red "press enter ==>"
# read a
# This can fail
time repo sync && \
    cecho green -e "\noooooooooooooooooooo ** repo PASSED **\n"  || \
    cecho red -e   "\n#################### ** repo sync FAILED **\n"

cecho $STEP_COLOR "saving sym refs in horizon.post"
repo_save_horizon > horizon.post

repo_restore_horizon  horizon.pre horizon.post

cecho cyan "Check any difference"
repo_save_horizon > horizon.restored


# can this fail?
repo_restore_horizon -d horizon.pre horizon.restored && \
    cecho green -e "\noooooooooooooooooooo ** rebase PASSED **\n"  || \
    cecho red -e   "\n#################### ** rebase FAILED **\n"


# show changelog
cecho $STEP_COLOR "saving sha1-s in git-heads.txt."
repo forall -c 'echo $REPO_PATH `git log --format="format:%H" --max-count=1`' > git-heads.txt

if test -e $start_git_heads;
    then
    # --no-pager
    vendor/tomtom/build/tools/platform-diff \
	--cherry-pick --format=oneline --right-only --no-merges \
	$start_git_heads git-heads.txt
fi
