#! /bin/zsh -fue

# invoke repo sync, and then restore the checked-out branches.
# It's assumed they know how to rebase. ( git-rebase-* cmds)

STEP_COLOR=green


save_horizon_and_heads()
{
    start_git_heads=$1
    horizon_file=$2
    # we reused previously created git-heads.txt file.
# cecho $STEP_COLOR "saving sha1-s in git-heads.txt ... in background"
# don't fail if the file is missing:
    test -f git-heads.txt && mv -f git-heads.txt $start_git_heads
# taken from gen_platform_zip:


    {
    #pid1=$tmpsess
	cecho $STEP_COLOR "saving sym refs in horizon.pre"
	(repo_save_horizon > $horizon_file || rm -f $horizon_file) &
    #pid2=$tmpsess
	wait
    #$pid1 $pid2
    }

}


start_git_heads=git-heads.txt-$(date +%d-%H)
save_horizon_and_heads $start_git_heads horizon.pre

cecho blue "Here the sym-ref horizon:"
cat horizon.pre

#cecho red "press enter ==>"
# read a
# This can fail

sync_status=0
if time repo sync; then
    cecho green -e "\noooooooooooooooooooo ** repo PASSED **\n"
else
    sync_status=1
    cecho red -e   "\n#################### ** repo sync FAILED **\n"
fi

#cecho $STEP_COLOR "saving sym refs in horizon.post"
#repo-repair -t horizon.post horizon.pre

if repo-restore.awk < horizon.pre;
then
    cecho green -e "\noooooooooooooooooooo ** rebase PASSED **\n"
else
    {cecho red -e   "\n#################### ** rebase FAILED **\n"; exit 1}
fi



# fixme: no point in stashing again!
cecho cyan "Check any difference"
# todo --dont-stash
repo_save_horizon -s > horizon.restored


# can this fail?
if false;
then
    repo_restore_horizon -d horizon.pre horizon.restored && \
    cecho green -e "\noooooooooooooooooooo ** rebase PASSED **\n"  || \
    cecho red -e   "\n#################### ** rebase FAILED **\n"
fi

#todo: this is useless if the `rebase' failed:
# show changelog
cecho $STEP_COLOR "saving sha1-s in git-heads.txt."
repo forall -c 'echo $REPO_PATH `git log --format="format:%H" --max-count=1`' > git-heads.txt

if test -e $start_git_heads;
    then
    # --no-pager
    repo-diff $start_git_heads git-heads.txt
fi

exit $sync_status

