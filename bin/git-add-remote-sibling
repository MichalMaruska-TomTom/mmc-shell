#!/bin/zsh -eu

# Tool to setup a mirror of git repositories in an identical dir-hierarchy (on 2 hosts).
# This is only about SSH-based git. not git:// urls!
# Add as a `git remote host' maruskadell, with the path same as this one.

# die ... maybe git-functions should source it?
source /usr/share/mmc-shell/mmc-functions.sh
source /usr/share/mmc-shell/git-functions.sh
set -x
usage()
{
    cat <<EOF
usage: ${0##*/} [+-h] [-n URL] [-d]
-d verbose
-n ex. ${GIT_REMOTE_NAME-}
-u ex ${GIT_URL-}
EOF
}

#possible wrapped into echo(1). for a dry run.
CMD=
clone=n

remote_path=$(get_remote_path)

override=n
verbose=n
while getopts :hcdfn:u:v OPT; do
    case $OPT in
        c)
            clone=y
            ;;
        f)
            override=y
            ;;
        d)
            # run_dry=y
            CMD=echo
            ;;
        h|+h)
            usage
            exit 0
            ;;
        n|+n)
            GIT_REMOTE_NAME=$OPTARG
            ;;
        u)
            GIT_URL=$OPTARG
            ;;
        v)
            verbose=y
            ;;
        *)
            usage >&2
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $# -gt 0 ]; then
    usage
    exit 1
fi

# set_remote_name
guess_twin

if [[ $clone = "y" ]];
then
    $CMD git clone $GIT_URL:$remote_path
else

    if [ $override = y ]; then
        $CMD git remote set-url $GIT_REMOTE_NAME $GIT_URL:$remote_path
    else
        $CMD git remote add $GIT_REMOTE_NAME $GIT_URL
    fi

    git fetch $GIT_REMOTE_NAME
fi
