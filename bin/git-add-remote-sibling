#!/bin/zsh -eu

# Tool to setup a mirror of git repositories in an identical dir-hierarchy (on 2 hosts).
# This is only about SSH-based git. not git:// urls!
# Add as a `git remote host' maruskadell, with the path same as this one.

source /usr/share/mmc-shell/git-functions.sh
set_remote_name

usage()
{
    cat <<EOF
usage: ${0##*/} [+-h] [-n URL] [-d]
-d verbose
-n ex. ${GIT_REMOTE_NAME-}
-u ex ${GIT_URL-}
EOF
}

#possible wrapped into echo(1). for a dry run.
CMD=

function get_remote_path()
{
    # Strip $HOME
    local local_path=$(pwd)
    local_path=${local_path#$HOME}

    local remote_home=/home/michal

    remote_path=$remote_home$local_path
    echo $remote_path
}

remote_path=$(get_remote_path)

override=n
while getopts :hfvdn:u: OPT; do
    case $OPT in
        f)
            override=y
            ;;
        d)
            # run_dry=y
            CMD=echo
            ;;
        h|+h)
            usage
            exit 0
            ;;
        u)
            GIT_URL=$OPTARG
            ;;
        n|+n)
            GIT_REMOTE_NAME=$OPTARG
            ;;
        *)
            usage >&2
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $# -gt 0 ]; then
    usage
    exit 1
fi


if [[ $clone ]];
then
    $CMD git clone $GIT_URL:$remote_path
else

    if [ $override = y ]; then
        $CMD git remote set-url $GIT_REMOTE_NAME $GIT_URL:$remote_path
    else
        $CMD git remote add $GIT_REMOTE_NAME $GIT_URL:$remote_path
    fi

    git fetch $GIT_REMOTE_NAME
fi
