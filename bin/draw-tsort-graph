#! /bin/zsh -fue

FORMAT=png
keep_graph_file=no

usage()
{
    setopt POSIX_ARGZERO
    cat <<EOF
usage: ${0##*/} [+-kpj] [-F format] [--] {file}
-h help
-d debug/trace
-p PNG
-P ps
-f pdf
-F format

***
Given a file prepared for tsort(1),
invoke dot(1) on it.
That means conversion + some header configuration.
EOF
}

invoke_xdot=no
extension=""

while getopts :dkpPfF: OPT; do
    case $OPT in
        h)
            usage
            exit 0
            ;;
        k|+k)
            keep_graph_file=yes
            ;;
        x)
            invoke_xdot=yes
            ;;
        p|+p)
            FORMAT=png
            extension=png
            ;;
        P)
            FORMAT=ps
            extension=ps
            ;;
        f)
            FORMAT=pdf
            extension=pdf
            ;;
        F)
            FORMAT=$OPTARG
            ;;
        d)
            set -x
            ;;
        *)
            usage
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1

temp=$(mktemp --tmpdir --suffix=.dot graph.XXX$extension)


echo "digraph { " >> $temp
echo "fontsize=24;" >> $temp
# size=\"64,48\";

# either from stdin or a file
if [ $# = 1 ];then
    cat $1 >> $temp
elif [ $# = 0 ]; then
    cat >> $temp
else
    usage >&2
    exit 1
fi

echo "}" >> $temp



echo $temp >&2


if [[ $invoke_xdot = yes ]]; then
    (set -x; xdot ${XDOT_PARAMS-} $temp)
else
    (set -x
     dot -T$FORMAT $temp
    )
fi


if [ $keep_graph_file = yes ];then
    echo "dot file $temp" >&2
else
    rm -f $temp
fi

#dot -Nshape=box  /tmp/file.dot > /tmp/file.jpeg
