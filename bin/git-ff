#!/bin/zsh -feu

source /usr/share/mmc-shell/git-functions.sh

# set -x
usage() {
    setopt POSIX_ARGZERO
    cat <<EOF
usage: ${0##*/} [+-h] [-f] [--]  [remote] [branch]

Fast-forward to remote head, stashing around.
-f not only fast-forward !

By default {branch} is the current one.
EOF
    unsetopt POSIX_ARGZERO
}

set_remote_name
# todo: the same I'm on
branch=$(current_branch_name)
force=n

while getopts :hf OPT; do
    case $OPT in
        h|+h)
            usage
            exit 0
            ;;
        f)
            force=y
            ;;
        *)
            usage >&2
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $# -gt 0 ]; then
    GIT_REMOTE_NAME=$1
    shift
fi

if [ $# -gt 0 ]; then
    branch=$1
    shift
fi

# fixme: if necessary:
stash_if_non_clean "merge fast-forward"

if [[ $force = y ]];
then
    git reset --hard remotes/$GIT_REMOTE_NAME/$branch
else
    # git checkout $branch
    git merge --ff-only $GIT_REMOTE_NAME/$branch
fi
unstash_if_stashed
