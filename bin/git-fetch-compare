#! /bin/zsh -feu

. /usr/share/mmc-shell/mmc-functions.sh
check_getopt


## Keep the local git repo up-to-date (fetch from remotes) & report situation.
## i.e. compare (local branch) head with a remote head.

## `Defaults'
branch=HEAD
push=yes
verbose=no
remotes=()

usage()
{
    setopt POSIX_ARGZERO
    cat <<EOF
usage: ${0##*/} [+-f] [-r <remote>| -a]  [--] ARGS...
-P | --pushto {remote}
-r | --remote [remote]   ....
-a | --all
--verbose
EOF
}

push=no

# how can I have optional argument to ... ?
cmd_options=$(getopt --name ${0##*/} --shell bash \
        --longoptions push,pushto:,remote,verbose --options r:pP:hv \
        -- "$@" ) || { usage && exit 1 }

eval set -- "$cmd_options"

while (( $# > 0 )); do
    case $1 in
        -p | --push )
            push=yes
            ;;
        -P | --pushto)
            shift
            push=$1
            ;;
        -h | --help)
            usage
            exit 0
            ;;
        --all | -a)
            remote="--all"
            ;;
        -r | --remote)
            shift
            # better +=
            remotes+=($1)
            ;;
        --)
             shift
             break
             ;;
        -v | --verbose)
            verbose=y
            ;;
        *)
            echo $1>&2
            usage
            exit 2
    esac
    shift
done

# Determine the remotes:
if [ $# -gt 0 ]; then
    remotes+=($@)
fi

# do the fetch
# todo: empty-array test?
if [ -z "${remotes}" ];
then
    if [ $verbose = y ]; then echo "will fetch from all remotes";fi

    git fetch "--all" --quiet
    git status --short
else
    if [ $verbose = y ]; then echo "will fetch from: $remotes";fi
    foreach remote ($remotes) {
        git fetch ${remote} --quiet
    }
fi

# report the change:
foreach remote ($remotes) {
    git-compare-remotes $remote master
}
