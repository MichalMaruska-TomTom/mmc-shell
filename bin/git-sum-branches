#! /usr/bin/zsh -feux
reset=n
dry=n

while getopts :rd OPT; do
    case $OPT in
	d)
	    dry=y;;
	r|+r)
	    # reset:
	    reset=y
	    ;;
	*)
	    print "usage: ${0##*/} [+-r} [--] ARGS..."
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $dry = "y" ]; then
    cmd="echo"
else
    cmd=""
fi

# "mmc-all"
sum_br=$1

dir=$(git rev-parse --show-toplevel)

# how to
typeset -a branches
_tmp=$(grep -v '^#' $dir/.git/mmc/$sum_br)
branches=(${(f)_tmp})

echo

# if exists such branch/tag ->abort
first=$branches[1]

others=($branches[2,-1])
#(mmc-fixes mmc-keep-time mmc-xi-adaptation mmc-debug-grabs mmc-plugin-loader mmc-handy michal-xkb)

#exit 1

if [ $reset = "y" ]; then
    eval $cmd git co $sum_br
    eval $cmd git reset --hard $first
fi
# git co -b $sum_br $first

foreach next ($others)
{
    eval $cmd git merge $next;
}
