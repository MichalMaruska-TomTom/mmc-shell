#! /bin/bash -ue

# Manage the Sum information:
# list ..
# add
# remove
#

usage()
{
    cat <<EOF
Usage:
${0##*/} [+-h]
${0##*/} branch
${0##*/} branch new-merge-branch
${0##*/} branch -drop-merge-branch

EOF
}


git-branch-exists()
{
    [ -e .git/refs/heads/$1 ]
}

show_prune_defintion()
{
    cat $1 | \
    while read a;do
	if git-branch-exists $a; then
	    echo $a
	else
	    echo NON-existant $a
	fi
    done
}




reset="n"

while getopts :hr OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	r)
	    reset="y"
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1



if [ $# -lt 1 ]; then
    usage
    exit -1
fi

name=$1
shift


# ensure-dir
[ -d .git/mmc/ ] || mkdir .git/mmc/
sum_file=.git/mmc/$name

if [ $reset = "y" ];then
    rm $sum_file
fi


if [ $# = 0 ]; then
    show_prune_defintion $sum_file
else
    for br in "$@"
    do
	case "$br" in
	    -*)
		br=$(expr substr "$br" 2 $(expr length "$br" ) )
		cecho red $br
		temp=${TEMP-/tmp}/git-define-sum
		grep -v -e "^$br$" $sum_file > $temp
		mv $temp $sum_file
		;;
	    +*)
		cecho green $br
		echo $br >> $sum_file
		;;
	    *)
		cecho green $br
		echo $br >> $sum_file
		;;
	esac
    done
    cat $sum_file
fi
