#! /usr/bin/zsh -feu

usage()
{
    cat <<EOF
Usage:  $0 [-m OK] cmd args

 invokes "CMD args", redirecting its output (also stderr!)
 then sends an email.
 if the status was 0,  email starts with OK, otherwise FAIL.
EOF
}

# fallback
: ${EMAIL=Michal.Maruska@tomtom.com}
while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	*)
	    usage >&2
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1


CMD=`shift`

TEMP=$(mktemp $CMD.XXXX)

# how to suppress the exit-on-failure here?
if $CMD "$@" &> $TEMP;
then
    result=0
else
    result=$?
#    echo "this way $result"
fi


if [ $result = 0 ];
then
    subject="OK $CMD"
else
    subject="FAIL $CMD"
fi

# stderr during this command is not controlled:
# and it might invoke gnome-keyring.
mail -s $subject $EMAIL < $TEMP

rm $TEMP
