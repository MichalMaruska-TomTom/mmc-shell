#! /usr/bin/zsh -feu

usage()
{
    cat <<EOF
Usage:  $0 [-s subject] cmd args

 invokes "CMD args", redirecting its output (also stderr!)
 then sends an email.
 if the status was 0,  email starts with "OK subject", otherwise "FAIL subject".
EOF
}

# fallback (if empty)
: ${MAILTO:=Michal.Maruska@tomtom.com}
while getopts :hs: OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	s)
	    subject=$OPTARG
	    ;;
	*)
	    usage >&2
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

CMD=$1; shift
TEMP=$(mktemp $CMD.XXXX.log)

# how to suppress the exit-on-failure here?
if $CMD "$@" &> $TEMP;
then
    result=0
else
    result=$?
#    echo "this way $result"
fi

# default/fall-back value
: ${subject=$CMD}


if [ $result = 0 ];
then
    subject="OK $subject"
else
    subject="FAIL $subject"
fi

# stderr during this command is not controlled:
# and it might invoke gnome-keyring.
mail -r "<CRON-DAEMON>" -s $subject -a "X-sender: cron-daemon" $MAILTO < $TEMP

rm $TEMP
