#! /usr/bin/zsh -feu

usage()
{
    cat <<EOF
usage: ${0##*/} [+-h} [--] branch symbolic-base [current-base]

EOF
}

while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	# d)  delete
	*)
	    print "usage: ${0##*/} [+-h} [--] ARGS..."
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

name=$1
basefile=.git/refs/base/$name
startfile=.git/refs/start/$name

if [ $# = 1 ]; then
    # cat $basefile
    # could be hash
    # or ref - tag or head.
    base=$(cat $basefile| sed -e 's/^ref: //' | sed -e 's|^refs/heads/||')
    cecho green $base
    cat $startfile
else
    from=$2

    base=$(git show-ref $from|head -n 1|cut -f 2 -d ' ')
    cecho yellow "so the base is $base"


    if [ $# -ge 3 ]; then
	# fixme: this is a pattern.
	#refs/heads/master
	start=$(git show-ref --hash $3)
    else
	start=$(git show-ref --hash $from)
	#if [ ${start} -gt 1 ]; then error;fi
    fi
    cecho yellow "so the start is $start"
    # git show $start

    # branch_exists $name
    [ -e .git/refs/heads/$name ] || git git br $name

    mkdir -p $(dirname $basefile) $(dirname $startfile)
# canonize:
    echo "ref: $base" > $basefile
    echo $start > $startfile
fi
