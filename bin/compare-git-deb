#! /bin/zsh -feu

# Compare
#  o  Git repository which carries a source debian package
# with
#  o  available debian package version.
usage()
{
    print "usage: ${0##*/} [+-h] [--] dir ..."
    # enters dir and compares its debian/changelog with what is installed (dpkg -l)
}

# fixme: must be invoked inside DIR.
while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $# -gt 0 ]; then
    DIR=$1
else
    DIR=.
fi

# cd $DIR;
last_release_tag=$(cd $DIR; git describe --tags HEAD 2>/dev/null)


# binary package, somehow representing the source package in that Git repo:
# todo:

deb_src_pkg=$(deb-pkg-name $DIR/debian/control*)
name=$deb_src_pkg


deb_pkg=$(deb-pkg-binary-packages $DIR)
info=$(deb-pkg-installed-version $deb_pkg |tail -n 1)
version=$info
#(echo $info)

# path from $FOR_EACH_BASE_DIR

if [ 0 = $? ]; then
    set +e
    post=$(expr match $last_release_tag '^.*-\([[:digit:]]\+\)-[[:alnum:]]\+$')
    match_status=$?

    gitversion=${${last_release_tag#*/}%%-*}

    set -e
    if [ $match_status = 0 ];
    then
	#echo -n "$post "
	tag=$(expr match $last_release_tag '^\(.*\)-[[:digit:]]\+-[[:alnum:]]\+$')
	cecho hiyellow -n $name
	echo -n -e '\tis '
	cecho cyan -n $post
	echo " commits ahead of\t $tag"

	if [ "$gitversion" != "$version" ]; then
	    cecho blue -e "\tdifferent versions: $gitversion vs $version"
	fi


	git --no-pager log --format='%C(green)%h %C(blue)%s' $tag..HEAD
	# git log --oneline $tag..HEAD
	echo
    else
	if [ "$gitversion" != "$version" ]; then
	    cecho red -e $name  '\t' $last_release_tag  '\t installed:' $version
	else
	    cecho reset -e $name  '\t' $last_release_tag
	    #   '\t installed:' $version
	fi
    fi
fi
