#! /usr/bin/zsh -feu

# Compare Git repository which carries a source debian package
# with what is released as a debian package.

# fixme: must be invoked inside DIR.
DIR=$1
name=$(basename $(readlink -e .))

last_release_tag=$(git describe --tags HEAD 2>/dev/null)



# binary package, somehow representing the source package in that Git repo:
# todo:

debpkg=$(deb-pkg-name debian/control*)
info=$(deb-pkg-installed-version $debpkg |tail -n 1)


version=$info
#(echo $info)

# path from $FOR_EACH_BASE_DIR

if [ 0 = $? ]; then
    set +e
    post=$(expr match $last_release_tag '^.*-\([[:digit:]]\+\)-[[:alnum:]]\+$')
    match_status=$?
    set -e
    if [ $match_status = 0 ];
    then
	#echo -n "$post "
	tag=$(expr match $last_release_tag '^\(.*\)-[[:digit:]]\+-[[:alnum:]]\+$')
	cecho red -n $name
	echo -e '\tis ' $post " commits ahead of\t $tag"
    else
	gitversion=${last_release_tag#*/}
	if [ "$gitversion" != "$version" ]; then
	    cecho yellow -e $name  '\t' $last_release_tag  '\t installed:' $version
	    else
	    echo -e $name  '\t' $last_release_tag  '\t installed:' $version
	fi
    fi
fi
