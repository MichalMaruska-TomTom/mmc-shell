#! /usr/bin/zsh -feu
# pipefail

unsetopt FUNCTION_ARGZERO


TAB='	'
DRY_RUN=no

usage()
{
    cat <<EOF
usage: ${0##*/} [+-dvh} [--] ARGS...

 Invoke 'git-restate' in each repo project, that is messed-up.
 As input (the mess-up diff) it takes 2 'horizon' files.

EOF
}


compare_horizons()
{
    # 2 files
    # project  ref
    # find which missed in 2nd file, and differences.
    # \s instead of space. not correct.

    # set difference: 1 - 2 by joining by fields 1, 1
    join -t "$TAB" -v 1 \
	-1 1 -2 1 \
	$1 $2  |\
    (
	if test "$DRY_RUN" = yes;
	then
	    cat
	else
	    # fixme: failure of `system' won't exit the awk!
	    awk '/^(.*)\s(.*)$/  {\
result=system(sprintf("git-restate %s  %s", $1, $2));\
if (result != 0) { printf "failed %d", result; exit result}; }'
	fi
    )
# join -t '\t' -v 1 $1 $2
# join -v 2 $1 $2
# colordiff --unified=1 .$1.br .$2.br
}


while getopts :dh OPT; do
    case $OPT in
	d|+d)
	    DRY_RUN=yes
	    ;;
#	v|+v)
#	    ;;
	h|+h)
	    usage
	    exit
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

if [ $# -lt 2 ]; then
    usage
    exit 1
fi

# not on a ref now:

# different refs:

# equalize-horizon:
compare_horizons $1 $2
