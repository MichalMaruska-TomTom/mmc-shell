#! /bin/bash -eu
# pipefail

TAB='	'
dry=no

usage()
{
    echo "usage: ${0##*/} [+-dvh} [--] ARGS..."
}


compare_horizons()
{
    # 2 files
    # project  ref
    # find which missed in 2nd file, and differences.
    # \s instead of space. not correct.

    # set difference: 1 - 2 by joining by fields 1, 1
    join -t "$TAB" -v 1 \
	-1 1 -2 1 \
	$1 $2  |\
    (
	if test "$dry" = yes;
	then
	    cat
	else
	    # fixme: failure of `system' won't exit the awk!
	    awk '/^(.*)\s(.*)$/  {if (system(sprintf("git-restate %s  %s", $1, $2)) != 0);{ exit 1}; }'
	fi
    )
# join -t '\t' -v 1 $1 $2
# join -v 2 $1 $2
# colordiff --unified=1 .$1.br .$2.br
}


while getopts :dh OPT; do
    case $OPT in
	d|+d)
	    dry=yes
	    ;;
#	v|+v)
#	    ;;
	h|+h)
	    usage
	    exit
	    ;;
	*)
	    usage
	    exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1


# not on a ref now:

# different refs:

# equalize-horizon:
compare_horizons $1 $2
