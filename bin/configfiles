#!/bin/zsh -feu

usage()
{
    cat <<EOF
usage: ${0##*/} [-l] [+-h] <backup root>

-l  list the user-MODIFIED conffiles of debian.
copy to backup-root

(better to invoke as root -- needs read access)
EOF
}

list_only=n

while getopts :hl OPT; do
    case $OPT in
        l)
            list_only=y
            ;;
        h|+h)
            usage
            exit 0
            ;;
        *)
            usage >&2
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [[ $list_only == n ]]
then
    if [[ $(id --user) != 0 ]]; then
        usage >&2
        exit 1
    fi
    if [[ $# -lt 1 ]]
    then
        usage >&2
        exit 1
    else
        backup_root=$1
        shift
    fi
fi


copy_file()
{
    # cp --archive
    rsync --relative $1 $backup_root
}

dpkg-query --showformat='${Conffiles}\n' --show |\
    grep -v -e '^$'|
    while read file hash; do
        if [[ ! -f $file ]]
        then
            cecho blue "missing $file"
        elif [[ $hash != $(md5sum $file| cut -f 1 -d ' ') ]]
        then
            ls -l $file
            cecho red "$hash\n"
            cecho yellow $(md5sum $file| cut -f 1 -d ' ')
            if [[ $list_only = n ]]; then
                copy_file $file
            fi
        else
            # cecho yellow "ok $file"
        fi
    done
#.dpkg-dist
#.dpkg-new
find /etc/ -name '*.dpkg-old' | \
    while read filename; do
        ls -l $filename
        if [[ $list_only = n ]]; then
            copy_file $filename
        fi
    done

