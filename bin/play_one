#! /bin/zsh -f

function play_mplayer()
{
    mplayer -vo none -really-quiet -ao pulse,alsa "$1" </dev/null
}


usage()
{
    print "usage: ${0##*/} [+-va} [--] ARGS..."
}

alsa=n
use_gst=no
pulse=n

while getopts :vahpg OPT; do
    case $OPT in
        g)
            use_gst=yes
            MPG123=(gst123 --novideo --quiet)
            ;;
        v|+v)
            set -x
            ;;
        a|+a)
            alsa=y
            MPG123=(mpg123-alsa --gapless ${playdsp+-a $playdsp} --aggressive -q)
            ;;
        p)
            pulse=y
            MPG123=(mpg123-pulse --gapless ${playdsp+-a $playdsp} --aggressive -q)
            ;;
        h)
            usage
            exit 0
            ;;
        *)
            usage
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1


# decide:
if [[ "$pulse$alsa" = "nn" ]]; then
   # try more:
   if pulseaudio --check; then
       # this suddenly requires staying in fg! and "space" to pause.
       MPG123=(mpg123-pulse --no-control --gapless ${playdsp+-a $playdsp} --aggressive -q)
   elif which mpg321 > /dev/null; then
       # -b 10000
       MPG123=(mpg321 --aggressive -q)
   fi
fi

function play_one ()
{
    # cecho  red "play $1:"
    case $(realpath $1) in
        *.mpg)
        # mpg123 -b 10000 "$1" ;;
            cecho green $1
            $MPG123 "$1"
            ;;
        *.mp2)
            cecho green $1
            $MPG123  "$1" ;;

         *.xmms.mp3)
            echo xmms  --play ${1}
            ;;
        *.mp3)
            cecho green "$1"
        #    echo `color red`  `color bd` $1 `color off`

       # mpg321 skips when over Net!
       # --buffer 10000
       # problems w/ hi bit-rates!
       # mpg321 --aggressive -o alsa09 -q -b 10000  "$1"

       # -b 10000    ... fails silently!
       # fixme: this is oss, not ALSA!
            $MPG123  "$1"
            ;;

        *.ogg)
            cecho green "$1"
            ogg123 --quiet  "$1";;

        *.flv | *.mp4 | *.m4a | *.wma | *.webm | *.ape | *.mkv )
            cecho green "$1"
            #
            if which mplayer > /dev/null && [[ $use_gst == 'no' ]] ; then
                play_mplayer $1
            else
                DISPLAY= gst123 --novideo --quiet "$1"
            fi
            ;;

        *.flac)
            cecho green "$1"
            if which mplayer > /dev/null ; then
                play_mplayer $1
            else
                # gst123 --quiet $1 &> /dev/null </dev/null
                # gst123 insists on having the console (being in foregroung).
                flac --silent --decode --stdout $1 | aplay  -q  -
            fi
            ;;
        *tif|*png|*txt|*jpg)
            # skip those
            ;;
        *)
            # especially when a symlink to mp3:
            $MPG123 "$1"
            # play_mplayer $1
            ;;
    esac
}



for file in "$@"; do
    play_one $file
done
