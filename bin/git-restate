#! /bin/zsh -feu

unsetopt FUNCTION_ARGZERO

usage()
{
    cat <<EOF
usage: ${0##*/} DIR HEAD
EOF
}
# In directory @dir, assumed git,
# checks-out @head, possibly rebasing it by `git-rebase-poset'


if [ $# -lt 2 ]; then
    usage
    exit 1
fi

dir=$1
GIT_REF=${2#refs/heads/}

cecho hiyellow "-- $dir"
cd $dir


# but is the base pre_fetch_head?
if git-segment $GIT_REF &> /dev/null ||
    git-sum $GIT_REF &> /dev/null
then
    git-rebase-poset $GIT_REF
    git checkout $GIT_REF
else
    git checkout $GIT_REF
fi


# join -t ' ' -v 1 -1 1 -2 1   $1 $2 |\
# awk '/^(.*) (.*)$/  {system(sprintf("echo %s  %s", $1, $2));}'


# exists base ->
# git br -f base tt-server/ics-dev
# git-rebase-poset all

# repo_save_horizon > .now

# join -t ' ' -v 1 -1 1 -2 1   .pre.br .now  |\
# awk '/^(.*) (.*)$/  {system(sprintf("~/git-restate %s  %s", $1, $2));}'
