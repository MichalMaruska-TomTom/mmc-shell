#!/bin/zsh -feu

# Pure pulse-audio switching between sinks.
# No alsa access.

source /usr/share/mmc-shell/mmc-functions.sh
colors

sink_number()
{
    pactl list short sinks|grep -e $1 | cut -f 1
}

usage()
{
    cat <<EOF
usage: ${0##*/} [+-pbsh] [-l]
-b builtin

-p  phones
-s  speakers

-l list sinks
EOF
}


move_to()
{
    local sink=$1
    # sink_input=$(pactl list short sink-inputs|cut -f 1)
    pactl set-default-sink $sink

    pactl list short sink-inputs|cut -f 1 |
        while read si
        do
            pactl move-sink-input $si $sink
        done
}

activate_profile()
{
    local CARD=$1
    local PROFILE=$2
    pactl set-card-profile $CARD $PROFILE
}

WD15_SINK_REGEXP='USB.*Dock_0'
# WD15_SINK_REGEXP='USB.*Dock_1'
WD15_SINK_REGEXP='Generic_USB_Audio_200901010001'

wd15card="alsa_card.usb-Generic_USB_Audio_200901010001-00"
while getopts :bhlpsi: OPT; do
    case $OPT in
        p|+p)
            activate_profile $wd15card \
                             "output:analog-stereo-headphone+input:analog-stereo-mic"
            headphones=$(sink_number $WD15_SINK_REGEXP)
            move_to $headphones
            ;;
        b|+b)
            builtin=$(sink_number "alsa_output.pci-0000_00_1f.3.analog-stereo")
            move_to $builtin
            ;;
        s|+s)
            activate_profile $wd15card "output:analog-stereo-speaker"
            speakers=$(sink_number $WD15_SINK_REGEXP)
            move_to $speakers
            ;;
        h|+h)
            usage
            exit 0
            ;;
        i)
            move_to $OPTARG
            ;;
        l)
            LOG_STEP "sinks-inputs"
            pactl list short sink-inputs
            LOG_STEP "sinks:"
            pactl list short sinks
            ;;
        *)
            usage >&2
            exit 2
    esac
done
shift OPTIND-1
OPTIND=1


erase_configuration_file()
{
    local tdb_file=$1

    drop=(sink-input-by-application-name:MPlayer
          sink-input-by-application-name:mpg123
          sink-input-by-application-name:gthumb
          'sink-input-by-application-name:libao[ogg123]'
         )

    foreach key ($drop) {
        if false; then
            tdbtool $tdb_file delete "$key"
        fi
    }
}


erase_configuration_file  ~/.config/pulse/*-stream-volumes.tdb
